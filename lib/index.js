// Generated by CoffeeScript 2.0.0-beta6
void function () {
  var buildAst, DEFAULT_EXPORT_IDENTIFIER, esprima, generateFunctionBody, generateTemplateAssignmentNode, getLHSExportExpression, readr, TEMPLATE_IDENTIFIER;
  readr = require('readr');
  esprima = require('esprima');
  TEMPLATE_IDENTIFIER = 'templates';
  DEFAULT_EXPORT_IDENTIFIER = 'AppTemplates';
  module.exports = function (path, options) {
    var files;
    if (null == options)
      options = {};
    files = readr.sync(path, options);
    return buildAst(files, options);
  };
  buildAst = function (files, options) {
    var body, wrapper;
    wrapper = esprima.parse('(function(global){}).call(this, this)');
    body = generateFunctionBody(files, options);
    wrapper.body[0].expression.callee.object.body.body = body;
    return wrapper;
  };
  generateFunctionBody = function (files, options) {
    var exportAssignment, exportExpression, lhsExpression, templateAssigments, templateVarDeclaration;
    templateVarDeclaration = esprima.parse('var ' + TEMPLATE_IDENTIFIER + ' = {};').body[0];
    templateAssigments = files.map(generateTemplateAssignmentNode);
    exportExpression = esprima.parse(getLHSExportExpression(options)).body[0].expression;
    lhsExpression = exportExpression.type === 'Identifier' ? {
      type: 'MemberExpression',
      computed: false,
      object: {
        type: 'Identifier',
        name: 'global'
      },
      property: {
        type: 'Identifier',
        name: exportExpression.name
      }
    } : exportExpression;
    exportAssignment = {
      type: 'ExpressionStatement',
      expression: {
        type: 'AssignmentExpression',
        operator: '=',
        left: lhsExpression,
        right: {
          type: 'Identifier',
          name: TEMPLATE_IDENTIFIER
        }
      }
    };
    return [templateVarDeclaration].concat(templateAssigments).concat(exportAssignment);
  };
  generateTemplateAssignmentNode = function (file) {
    return {
      type: 'ExpressionStatement',
      expression: {
        type: 'AssignmentExpression',
        operator: '=',
        left: {
          type: 'MemberExpression',
          computed: true,
          object: {
            type: 'Identifier',
            name: TEMPLATE_IDENTIFIER
          },
          property: {
            type: 'Literal',
            value: null != file.friendlyPath ? file.friendlyPath : file.path
          }
        },
        right: {
          type: 'Literal',
          value: file.contents
        }
      }
    };
  };
  getLHSExportExpression = function (options) {
    if (options.commonjs)
      return 'module.exports';
    if (null != options['export'])
      return options['export'];
    return DEFAULT_EXPORT_IDENTIFIER;
  };
}.call(this);
